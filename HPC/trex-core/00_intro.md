# t-rex
## 基本介绍
t-rex 是一个高性能的软件实现的流量生成与测试平台。
- 可以生成L4-7层的流量
- 可以根据真实流量模板进行预处理然后播放有状态的流量
- 可以生成并模拟 client端和server端的流量
- 可以灵活添加到自定义函数
- 支持虚拟网卡
### stateless mode
“Stateless” mode is meant to test networking gear that does not manage any state per flow (instead operating on a per packet basis). This is usually done by injecting customized packet streams to the device under test.  
主要用于测试L2/L3层流量，packet based
- 不用在意上下文，性能最高
### stateful mode
“Stateful” mode is meant for testing networking gear which saves state per flow (5 tuple). Usually this is done by injecting pre-recorded capture files on pairs of interfaces of the device under test, and dynamically changing src/dst IP/port. With advance Stateful mode it done by injecting L7 data on top of TCP/UDP potocols  
主要用于测试L4-L7层流量，及一些需要对流状态进行存储的网络设备，更加关注于模拟的真实性，以及对DUT的状态维持能力的测试，Flow based  
- 负载均衡
- DPI/AVC
- firewall
- NAT
## 安装配置
### 安装dpdk
注意：并不是所有支持dpdk的网卡都支持TRex（比较蛋疼）
### 安装trex
### 测试平台配置 (配置文件各项参数可以参考官方文档[6.Reference](https://trex-tgn.cisco.com/trex/doc/trex_manual.html#_reference))
1. 使用命令`sudo ./scripts/dpdk_devbind.py -s`查看需要trex需要使用的网卡
2. 使用命令`sudo ./scripts/dpdk_setup_ports.py -i`可以自动生成trex配置文件,官方样例配置文件在`./scripts/cfg`目录下  
基于ip的配置`/etc/trex_cfg.yaml`
```
### Config file generated by dpdk_setup_ports.py ###
  
- version: 2
  interfaces: ['d8:00.0', 'd8:00.1']    # trex 使用的网卡PCI地址，这里也可以是linux 内核网卡，也可以是memif接口
  port_info:                            # 网卡port的信息
      - ip:  11.11.11.2                 # trex port0的IP地址，trex内部模拟的流量，都会从这里走出，然后根据下面的路由去往DUT网络
        default_gw:  11.11.11.1         # 连接port0的下一跳路由的IP地址
      - ip: 12.12.12.2                  # trex port1的IP地址，trex内部模拟的流量，都会从这里走出，然后根据下面的路由去往DUT网络
        default_gw: 12.12.12.1          # 连接port1的下一跳路由的IP地址
                                        # trex会发arp包，如果有问题可以让trex成为server模式，主动发起arp包

  platform:                             # 硬件平台信息
      master_thread_id: 0
      latency_thread_id: 1
      dual_if:
        - socket: 1
          threads: [12,13,14,15,16,17,18,19,20,21,22,23,36,37,38,39,40,41,42,43,44,45,46,47]
```
也可以使用基于MAC的配置
```
- port_limit      : 2
    port_info       :  # set eh mac addr
    - dest_mac        :   [0x0,0x0,0x0,0x1,0x0,0x0] # port0下一跳的mac
      src_mac         :   [0x0,0x0,0x0,0x2,0x0,0x0] # port0的mac
    - dest_mac        :   [0x0,0x0,0x0,0x3,0x0,0x0] # port1下一跳的mac
      src_mac         :   [0x0,0x0,0x0,0x4,0x0,0x0] # port1的mac
```
`./scripts/dpdk_setup_ports.py`还有其他功能可以通过-h查看
3. 配置路由或arp  
- 针对ip的trex配置还需要配置路由  
  - 配置静态路由
```
ip route add 16.0.0.0/8 via 11.11.11.2
ip route add 48.0.0.0/8 via 12.12.12.2
```
  - 配置策略路由PBR
- 针对mac的trex配置还需要配置静态arp
```
arp -s 11.11.11.2 00:00:00:02:00:00 # port0的arp
arp -s 12.12.12.2 00:00:00:04:00:00 # port1的arp
``` 
### 测试场景配置
1. 如果使用启动trex时用`-f`参数需要写一个trex流量配置文件，
```
- duration : 10.0
  generator :                           # 流量生成配置
          distribution : "seq"          
          clients_start : "16.0.0.1"    # 模拟客户端起始ip
          clients_end   : "16.0.1.255"  # 模拟客户端结束ip
          servers_start : "48.0.0.1"    # 模拟服务端起始ip
          servers_end   : "48.0.0.255"  # 模拟服务端结束ip
          clients_per_gb : 201
          min_clients    : 101
          dual_port_mask : "1.0.0.0" 
          tcp_aging      : 1
          udp_aging      : 1
  cap_info : 
     - name: cap2/dns.pcap              # pcap 文件路径
       cps : 1.0                        # connections per second
       ipg : 10000                      # inter-packet gap(microseconds). 10,000 = 10msec
       rtt : 10000                      # 要和igp数值相同
       w   : 1
```
## usage
### CLI
```
sudo ./t-rex-64 -f <traffic_yaml> -m <multiplier>
-d <duration>
-l <latency testrate>
-c <cores>
--limit-arp-request <arp count>
-v <verbose level>
``` 
可以使用CLI程序`./scripts/t-rex-64`启动trex
- --cfg <cfg.yaml>指定配置文件
- -c <core number>指定使用核数
- -d <duration>测试时长
- -p send the client side packets from both interface(通常只从client ports发，要小心使用这个选项，容易造成路由问题)
### API
### GUI
### example
|name|description|
|-|-|
cap2/imix_fast_1g.yaml|用于测试优化DRAM性能(1600flows)|
cap2/imix_fast_1g_100k.yaml|100kflows|
cap2/dns.yaml|simple dns pcap file|
cap2/http_simple.yaml|simple http cap file
avl/sfr_*.yaml|混合流量测试集（通常是1Gbps，-m 多少就是多少Gbps）|
avl/sfr_delay_10_1g_no_bundeling.yaml|sfr traffic profile capture from Avalanche - Spirent without bundeling support with RTT=10msec ( a delay machine), this can be used with --ipv6 and --learn-mode|
avl/sfr_delay_10_1g.yaml|head-end sfr traffic profile capture from Avalanche - Spirent with bundeling support with RTT=10msec ( a delay machine), it is normalized to 1Gb/sec for m=1|
avl/sfr_branch_profile_delay_10.yaml|branch sfr profile capture from Avalanche - Spirent with bundeling support with RTT=10msec it, is normalized to 1Gb/sec for m=1|
cap2/imix_64.yaml|64byte UDP packets profile|
## misc
### Measuring Jitter/Latency
trex使用SCTP/ICMP包探测扰动和延迟`--l-pkt-mode <0-3>`
|Option ID |	Type|
|-|-|
|0|default, SCTP packets|
|1|ICMP echo request packets from both sides|
|2|Send ICMP requests from one side, and matching ICMP responses from other side.This is particulary usefull if your DUT drops traffic from outside, and you need to open pin hole to get the outside traffic in (for example when testing a firewall)|
|3|Send ICMP request packets with a constant 0 sequence number from both sides. |
### 混杂模式
TRex port只收取目的MAC地址是这个port的mac的数据包，但可以通过配置promiscuous mode(混杂模式)来让port接受不同mac的包
- CLI: `portattr -a --prom`
- Python API: `client.set_port_attr(my_ports,promiscuous = True)`